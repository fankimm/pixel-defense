const i18n = {
    // Top 15 languages by global usage (including Korean)
    translations: {
        en: {
            // UI
            wave: "Wave",
            coins: "Coins",
            startWave: "Start Wave",
            waveInProgress: "Wave in Progress",
            auto: "Auto",
            hp: "HP",
            speed: "Speed",
            gameOver: "Game Over!",
            youReachedWave: "You reached wave",
            highScore: "High Score: Wave",
            playAgain: "Play Again",
            spawn: "SPAWN",
            newGame: "New Game",
            confirmNewGame: "Start a new game? Current progress will be lost.",

            // Tower names
            basic: "Basic",
            sniper: "Sniper",
            splash: "Splash",
            ice: "Ice",
            poison: "Poison",
            chain: "Chain",
            laser: "Laser",

            // Tower upgrade
            towerUpgrade: "Tower Upgrade",
            level: "Level",
            damage: "Damage",
            range: "Range",
            upgrade: "Upgrade",
            sell: "Sell",
            close: "Close",

            // Ads
            ads: [
                "Hot singles in your area want to play tower defense!",
                "Doctors HATE this one weird trick to defeat enemies!",
                "You won't believe what Wave 50 looks like!",
                "Download RAM to make your towers shoot faster!",
                "This tower defense game is banned in 0 countries!",
                "Congratulations! You're our 1,000,000th defender!",
                "Scientists discovered this new tower type! Governments hate it!",
                "Get rich with this ONE SIMPLE tower placement!",
                "Your towers need updating! Click here! (Just kidding)",
                "Warning: Your defense is not optimized! (It's fine actually)"
            ]
        },

        zh: { // Chinese (Simplified)
            wave: "波次",
            coins: "金币",
            startWave: "开始波次",
            waveInProgress: "波次进行中",
            auto: "自动",
            hp: "生命值",
            speed: "速度",
            gameOver: "游戏结束！",
            youReachedWave: "你达到了第",
            highScore: "最高分：第",
            playAgain: "再玩一次",
            spawn: "出生点",
            newGame: "新游戏",
            confirmNewGame: "开始新游戏？当前进度将丢失。",
            basic: "基础",
            sniper: "狙击",
            splash: "溅射",
            ice: "冰冻",
            poison: "毒药",
            chain: "连锁",
            laser: "激光",
            towerUpgrade: "塔升级",
            level: "等级",
            damage: "伤害",
            range: "范围",
            upgrade: "升级",
            sell: "出售",
            close: "关闭",
            ads: [
                "你附近的单身想玩塔防游戏！",
                "医生最讨厌这个击败敌人的技巧！",
                "你不会相信第50波是什么样子！",
                "下载内存让你的塔射击更快！",
                "这个塔防游戏在0个国家被禁！",
                "恭喜！你是我们的第1000000个防御者！",
                "科学家发现了这种新的塔类型！政府讨厌它！",
                "用这个简单的塔位置致富！",
                "你的塔需要更新！点击这里！（开玩笑的）",
                "警告：你的防御未优化！（其实没事）"
            ]
        },

        es: { // Spanish
            wave: "Oleada",
            coins: "Monedas",
            startWave: "Iniciar Oleada",
            waveInProgress: "Oleada en Progreso",
            auto: "Auto",
            hp: "PV",
            speed: "Velocidad",
            gameOver: "¡Juego Terminado!",
            youReachedWave: "Llegaste a la oleada",
            highScore: "Puntuación Máxima: Oleada",
            playAgain: "Jugar de Nuevo",
            spawn: "INICIO",
            newGame: "Nuevo Juego",
            confirmNewGame: "¿Empezar un nuevo juego? Se perderá el progreso actual.",
            basic: "Básica",
            sniper: "Francotirador",
            splash: "Explosiva",
            ice: "Hielo",
            poison: "Veneno",
            chain: "Cadena",
            laser: "Láser",
            towerUpgrade: "Mejorar Torre",
            level: "Nivel",
            damage: "Daño",
            range: "Alcance",
            upgrade: "Mejorar",
            sell: "Vender",
            close: "Cerrar",
            ads: [
                "¡Solteros en tu área quieren jugar tower defense!",
                "¡Los médicos ODIAN este truco para derrotar enemigos!",
                "¡No creerás cómo es la Oleada 50!",
                "¡Descarga RAM para que tus torres disparen más rápido!",
                "¡Este juego está prohibido en 0 países!",
                "¡Felicidades! ¡Eres nuestro defensor número 1.000.000!",
                "¡Los científicos descubrieron este nuevo tipo de torre!",
                "¡Hazte rico con esta SIMPLE colocación de torre!",
                "¡Tus torres necesitan actualización! ¡Haz clic aquí! (Es broma)",
                "Advertencia: ¡Tu defensa no está optimizada! (En realidad está bien)"
            ]
        },

        hi: { // Hindi
            wave: "वेव",
            coins: "सिक्के",
            startWave: "वेव शुरू करें",
            waveInProgress: "वेव प्रगति में",
            auto: "ऑटो",
            hp: "एचपी",
            speed: "गति",
            gameOver: "गेम ओवर!",
            youReachedWave: "आप वेव तक पहुंचे",
            highScore: "हाई स्कोर: वेव",
            playAgain: "फिर से खेलें",
            spawn: "स्पॉन",
            basic: "बेसिक",
            sniper: "स्नाइपर",
            splash: "स्प्लैश",
            ice: "आइस",
            poison: "पॉइज़न",
            chain: "चेन",
            laser: "लेज़र",
            towerUpgrade: "टावर अपग्रेड",
            level: "लेवल",
            damage: "डैमेज",
            range: "रेंज",
            upgrade: "अपग्रेड",
            sell: "बेचें",
            close: "बंद करें",
            ads: [
                "आपके क्षेत्र में सिंगल्स टावर डिफेंस खेलना चाहते हैं!",
                "डॉक्टर इस ट्रिक से नफरत करते हैं!",
                "आप विश्वास नहीं करेंगे वेव 50 कैसी दिखती है!",
                "RAM डाउनलोड करें और टावर तेज़ी से शूट करें!",
                "यह गेम 0 देशों में प्रतिबंधित है!",
                "बधाई! आप हमारे 1,000,000वें डिफेंडर हैं!",
                "वैज्ञानिकों ने खोजा नया टावर टाइप!",
                "इस सिंपल टावर प्लेसमेंट से अमीर बनें!",
                "आपके टावर को अपडेट की ज़रूरत है! (मज़ाक कर रहे हैं)",
                "चेतावनी: आपका डिफेंस ऑप्टिमाइज़ नहीं है! (असल में ठीक है)"
            ]
        },

        ar: { // Arabic
            wave: "موجة",
            coins: "عملات",
            startWave: "ابدأ الموجة",
            waveInProgress: "الموجة قيد التقدم",
            auto: "تلقائي",
            hp: "الصحة",
            speed: "السرعة",
            gameOver: "انتهت اللعبة!",
            youReachedWave: "وصلت إلى الموجة",
            highScore: "أعلى نتيجة: موجة",
            playAgain: "العب مرة أخرى",
            spawn: "نقطة البداية",
            basic: "أساسي",
            sniper: "قناص",
            splash: "انفجار",
            ice: "ثلج",
            poison: "سم",
            chain: "سلسلة",
            laser: "ليزر",
            towerUpgrade: "ترقية البرج",
            level: "المستوى",
            damage: "الضرر",
            range: "المدى",
            upgrade: "ترقية",
            sell: "بيع",
            close: "إغلاق",
            ads: [
                "العزاب في منطقتك يريدون لعب الدفاع عن البرج!",
                "الأطباء يكرهون هذه الحيلة لهزيمة الأعداء!",
                "لن تصدق كيف تبدو الموجة 50!",
                "حمّل ذاكرة RAM لجعل أبراجك تطلق النار بشكل أسرع!",
                "هذه اللعبة محظورة في 0 دولة!",
                "تهانينا! أنت المدافع رقم 1,000,000!",
                "العلماء اكتشفوا نوع برج جديد!",
                "اثرِ بهذا الموضع البسيط للبرج!",
                "أبراجك تحتاج تحديث! انقر هنا! (مزحة)",
                "تحذير: دفاعك غير محسّن! (في الواقع بخير)"
            ]
        },

        pt: { // Portuguese
            wave: "Onda",
            coins: "Moedas",
            startWave: "Iniciar Onda",
            waveInProgress: "Onda em Progresso",
            auto: "Auto",
            hp: "PV",
            speed: "Velocidade",
            gameOver: "Fim de Jogo!",
            youReachedWave: "Você alcançou a onda",
            highScore: "Recorde: Onda",
            playAgain: "Jogar Novamente",
            spawn: "INÍCIO",
            basic: "Básica",
            sniper: "Sniper",
            splash: "Explosiva",
            ice: "Gelo",
            poison: "Veneno",
            chain: "Corrente",
            laser: "Laser",
            towerUpgrade: "Melhorar Torre",
            level: "Nível",
            damage: "Dano",
            range: "Alcance",
            upgrade: "Melhorar",
            sell: "Vender",
            close: "Fechar",
            ads: [
                "Solteiros na sua área querem jogar tower defense!",
                "Médicos ODEIAM este truque para derrotar inimigos!",
                "Você não vai acreditar na Onda 50!",
                "Baixe RAM para suas torres atirarem mais rápido!",
                "Este jogo está proibido em 0 países!",
                "Parabéns! Você é nosso defensor número 1.000.000!",
                "Cientistas descobriram este novo tipo de torre!",
                "Fique rico com esta SIMPLES colocação de torre!",
                "Suas torres precisam de atualização! Clique aqui! (Brincadeira)",
                "Aviso: Sua defesa não está otimizada! (Está tudo bem na verdade)"
            ]
        },

        ru: { // Russian
            wave: "Волна",
            coins: "Монеты",
            startWave: "Начать волну",
            waveInProgress: "Волна в процессе",
            auto: "Авто",
            hp: "ХП",
            speed: "Скорость",
            gameOver: "Игра окончена!",
            youReachedWave: "Вы достигли волны",
            highScore: "Рекорд: Волна",
            playAgain: "Играть снова",
            spawn: "СПАВН",
            basic: "Базовая",
            sniper: "Снайпер",
            splash: "Взрывная",
            ice: "Лед",
            poison: "Яд",
            chain: "Цепь",
            laser: "Лазер",
            towerUpgrade: "Улучшение башни",
            level: "Уровень",
            damage: "Урон",
            range: "Дальность",
            upgrade: "Улучшить",
            sell: "Продать",
            close: "Закрыть",
            ads: [
                "Одинокие в вашем районе хотят играть в tower defense!",
                "Врачи НЕНАВИДЯТ этот трюк для победы над врагами!",
                "Вы не поверите, как выглядит Волна 50!",
                "Скачайте RAM чтобы башни стреляли быстрее!",
                "Эта игра запрещена в 0 странах!",
                "Поздравляем! Вы наш 1.000.000-й защитник!",
                "Ученые открыли новый тип башни!",
                "Разбогатейте с этим ПРОСТЫМ размещением башни!",
                "Ваши башни нуждаются в обновлении! Нажмите здесь! (Шутка)",
                "Предупреждение: Ваша защита не оптимизирована! (На самом деле все хорошо)"
            ]
        },

        ja: { // Japanese
            wave: "ウェーブ",
            coins: "コイン",
            startWave: "ウェーブ開始",
            waveInProgress: "ウェーブ進行中",
            auto: "オート",
            hp: "HP",
            speed: "速度",
            gameOver: "ゲームオーバー！",
            youReachedWave: "ウェーブ",
            highScore: "ハイスコア：ウェーブ",
            playAgain: "もう一度プレイ",
            spawn: "スポーン",
            basic: "ベーシック",
            sniper: "スナイパー",
            splash: "スプラッシュ",
            ice: "アイス",
            poison: "ポイズン",
            chain: "チェイン",
            laser: "レーザー",
            towerUpgrade: "タワーアップグレード",
            level: "レベル",
            damage: "ダメージ",
            range: "範囲",
            upgrade: "アップグレード",
            sell: "売却",
            close: "閉じる",
            ads: [
                "あなたの地域のシングルがタワーディフェンスをプレイしたがっています！",
                "医者はこの敵を倒すトリックを嫌います！",
                "ウェーブ50がどんな感じか信じられません！",
                "RAMをダウンロードしてタワーの射撃を速くしよう！",
                "このゲームは0か国で禁止されています！",
                "おめでとうございます！あなたは1,000,000人目のディフェンダーです！",
                "科学者が新しいタワータイプを発見しました！",
                "このシンプルなタワー配置で金持ちになろう！",
                "タワーの更新が必要です！ここをクリック！（冗談です）",
                "警告：あなたの防御は最適化されていません！（実際は大丈夫）"
            ]
        },

        de: { // German
            wave: "Welle",
            coins: "Münzen",
            startWave: "Welle starten",
            waveInProgress: "Welle läuft",
            auto: "Auto",
            hp: "LP",
            speed: "Geschwindigkeit",
            gameOver: "Spiel vorbei!",
            youReachedWave: "Du hast Welle erreicht",
            highScore: "Highscore: Welle",
            playAgain: "Nochmal spielen",
            spawn: "START",
            basic: "Basis",
            sniper: "Scharfschütze",
            splash: "Explosion",
            ice: "Eis",
            poison: "Gift",
            chain: "Kette",
            laser: "Laser",
            towerUpgrade: "Turm verbessern",
            level: "Level",
            damage: "Schaden",
            range: "Reichweite",
            upgrade: "Verbessern",
            sell: "Verkaufen",
            close: "Schließen",
            ads: [
                "Singles in deiner Nähe wollen Tower Defense spielen!",
                "Ärzte HASSEN diesen Trick um Feinde zu besiegen!",
                "Du wirst nicht glauben wie Welle 50 aussieht!",
                "RAM herunterladen damit deine Türme schneller schießen!",
                "Dieses Spiel ist in 0 Ländern verboten!",
                "Glückwunsch! Du bist unser 1.000.000ster Verteidiger!",
                "Wissenschaftler entdeckten diesen neuen Turmtyp!",
                "Reich werden mit dieser EINFACHEN Turmplatzierung!",
                "Deine Türme brauchen ein Update! Hier klicken! (Nur Spaß)",
                "Warnung: Deine Verteidigung ist nicht optimiert! (Ist eigentlich ok)"
            ]
        },

        fr: { // French
            wave: "Vague",
            coins: "Pièces",
            startWave: "Démarrer la vague",
            waveInProgress: "Vague en cours",
            auto: "Auto",
            hp: "PV",
            speed: "Vitesse",
            gameOver: "Fin de partie!",
            youReachedWave: "Vous avez atteint la vague",
            highScore: "Meilleur score: Vague",
            playAgain: "Rejouer",
            spawn: "DÉPART",
            basic: "Basique",
            sniper: "Sniper",
            splash: "Explosif",
            ice: "Glace",
            poison: "Poison",
            chain: "Chaîne",
            laser: "Laser",
            towerUpgrade: "Améliorer la tour",
            level: "Niveau",
            damage: "Dégâts",
            range: "Portée",
            upgrade: "Améliorer",
            sell: "Vendre",
            close: "Fermer",
            ads: [
                "Des célibataires près de chez vous veulent jouer au tower defense!",
                "Les médecins DÉTESTENT cette astuce pour vaincre les ennemis!",
                "Vous ne croirez pas à quoi ressemble la Vague 50!",
                "Téléchargez de la RAM pour que vos tours tirent plus vite!",
                "Ce jeu est interdit dans 0 pays!",
                "Félicitations! Vous êtes notre 1.000.000ème défenseur!",
                "Les scientifiques ont découvert ce nouveau type de tour!",
                "Devenez riche avec ce placement de tour SIMPLE!",
                "Vos tours ont besoin d'une mise à jour! Cliquez ici! (C'est une blague)",
                "Attention: Votre défense n'est pas optimisée! (En fait c'est bon)"
            ]
        },

        ko: { // Korean
            wave: "웨이브",
            coins: "코인",
            startWave: "웨이브 시작",
            waveInProgress: "웨이브 진행 중",
            auto: "자동",
            hp: "체력",
            speed: "속도",
            gameOver: "게임 오버!",
            youReachedWave: "도달한 웨이브",
            highScore: "최고 기록: 웨이브",
            playAgain: "다시 하기",
            spawn: "시작",
            newGame: "새 게임",
            confirmNewGame: "새 게임을 시작하시겠습니까? 현재 진행 상황이 사라집니다.",
            basic: "기본",
            sniper: "저격",
            splash: "스플래시",
            ice: "얼음",
            poison: "독",
            chain: "체인",
            laser: "레이저",
            towerUpgrade: "타워 업그레이드",
            level: "레벨",
            damage: "데미지",
            range: "사거리",
            upgrade: "업그레이드",
            sell: "판매",
            close: "닫기",
            ads: [
                "당신 지역의 싱글들이 타워 디펜스를 플레이하고 싶어해요!",
                "의사들이 이 적 처치 비법을 싫어합니다!",
                "50 웨이브가 어떤지 믿지 못할 거예요!",
                "RAM을 다운로드해서 타워 발사 속도를 높이세요!",
                "이 게임은 0개국에서 금지되었습니다!",
                "축하합니다! 당신은 1,000,000번째 방어자입니다!",
                "과학자들이 새로운 타워 타입을 발견했습니다!",
                "이 간단한 타워 배치로 부자가 되세요!",
                "타워 업데이트가 필요합니다! 여기를 클릭! (농담입니다)",
                "경고: 당신의 방어가 최적화되지 않았습니다! (사실 괜찮아요)"
            ]
        },

        it: { // Italian
            wave: "Ondata",
            coins: "Monete",
            startWave: "Inizia ondata",
            waveInProgress: "Ondata in corso",
            auto: "Auto",
            hp: "PV",
            speed: "Velocità",
            gameOver: "Game Over!",
            youReachedWave: "Hai raggiunto l'ondata",
            highScore: "Record: Ondata",
            playAgain: "Gioca ancora",
            spawn: "INIZIO",
            basic: "Base",
            sniper: "Cecchino",
            splash: "Esplosiva",
            ice: "Ghiaccio",
            poison: "Veleno",
            chain: "Catena",
            laser: "Laser",
            towerUpgrade: "Potenzia torre",
            level: "Livello",
            damage: "Danno",
            range: "Raggio",
            upgrade: "Potenzia",
            sell: "Vendi",
            close: "Chiudi",
            ads: [
                "Single nella tua zona vogliono giocare a tower defense!",
                "I dottori ODIANO questo trucco per sconfiggere i nemici!",
                "Non crederai a come sia l'Ondata 50!",
                "Scarica RAM per far sparare le tue torri più velocemente!",
                "Questo gioco è vietato in 0 paesi!",
                "Congratulazioni! Sei il nostro 1.000.000° difensore!",
                "Gli scienziati hanno scoperto questo nuovo tipo di torre!",
                "Diventa ricco con questo SEMPLICE piazzamento di torre!",
                "Le tue torri necessitano aggiornamento! Clicca qui! (Scherzo)",
                "Attenzione: La tua difesa non è ottimizzata! (In realtà va bene)"
            ]
        },

        tr: { // Turkish
            wave: "Dalga",
            coins: "Para",
            startWave: "Dalgayı Başlat",
            waveInProgress: "Dalga Devam Ediyor",
            auto: "Oto",
            hp: "Can",
            speed: "Hız",
            gameOver: "Oyun Bitti!",
            youReachedWave: "Ulaştığınız dalga",
            highScore: "En Yüksek Skor: Dalga",
            playAgain: "Tekrar Oyna",
            spawn: "BAŞLANGIÇ",
            basic: "Temel",
            sniper: "Keskin Nişancı",
            splash: "Patlayıcı",
            ice: "Buz",
            poison: "Zehir",
            chain: "Zincir",
            laser: "Lazer",
            towerUpgrade: "Kule Geliştir",
            level: "Seviye",
            damage: "Hasar",
            range: "Menzil",
            upgrade: "Geliştir",
            sell: "Sat",
            close: "Kapat",
            ads: [
                "Bölgenizdeki bekarlar kule savunması oynamak istiyor!",
                "Doktorlar düşmanları yenmek için bu numaradan NEFRET ediyor!",
                "50. Dalganın nasıl göründüğüne inanamayacaksınız!",
                "Kulelerinizin daha hızlı ateş etmesi için RAM indirin!",
                "Bu oyun 0 ülkede yasaklandı!",
                "Tebrikler! 1.000.000'uncu savunmacımızsınız!",
                "Bilim insanları bu yeni kule türünü keşfetti!",
                "Bu BASİT kule yerleşimiyle zengin olun!",
                "Kulelerinizin güncellenmesi gerekiyor! Buraya tıklayın! (Şaka)",
                "Uyarı: Savunmanız optimize edilmemiş! (Aslında sorun yok)"
            ]
        },

        pl: { // Polish
            wave: "Fala",
            coins: "Monety",
            startWave: "Rozpocznij falę",
            waveInProgress: "Fala w toku",
            auto: "Auto",
            hp: "PŻ",
            speed: "Prędkość",
            gameOver: "Koniec gry!",
            youReachedWave: "Dotarłeś do fali",
            highScore: "Najlepszy wynik: Fala",
            playAgain: "Zagraj ponownie",
            spawn: "START",
            basic: "Podstawowa",
            sniper: "Snajper",
            splash: "Wybuchowa",
            ice: "Lód",
            poison: "Trucizna",
            chain: "Łańcuch",
            laser: "Laser",
            towerUpgrade: "Ulepszenie wieży",
            level: "Poziom",
            damage: "Obrażenia",
            range: "Zasięg",
            upgrade: "Ulepsz",
            sell: "Sprzedaj",
            close: "Zamknij",
            ads: [
                "Single w twojej okolicy chcą grać w tower defense!",
                "Lekarze NIENAWIDZĄ tej sztuczki na pokonanie wrogów!",
                "Nie uwierzysz jak wygląda Fala 50!",
                "Pobierz RAM żeby twoje wieże strzelały szybciej!",
                "Ta gra jest zakazana w 0 krajach!",
                "Gratulacje! Jesteś naszym 1.000.000 obrońcą!",
                "Naukowcy odkryli ten nowy typ wieży!",
                "Zostań bogaty z tym PROSTYM ustawieniem wieży!",
                "Twoje wieże potrzebują aktualizacji! Kliknij tutaj! (Żart)",
                "Ostrzeżenie: Twoja obrona nie jest zoptymalizowana! (Właściwie jest OK)"
            ]
        },

        nl: { // Dutch
            wave: "Golf",
            coins: "Munten",
            startWave: "Start golf",
            waveInProgress: "Golf bezig",
            auto: "Auto",
            hp: "LP",
            speed: "Snelheid",
            gameOver: "Game Over!",
            youReachedWave: "Je bereikte golf",
            highScore: "Hoogste score: Golf",
            playAgain: "Opnieuw spelen",
            spawn: "START",
            basic: "Basis",
            sniper: "Scherpschutter",
            splash: "Explosief",
            ice: "IJs",
            poison: "Vergif",
            chain: "Ketting",
            laser: "Laser",
            towerUpgrade: "Toren upgraden",
            level: "Level",
            damage: "Schade",
            range: "Bereik",
            upgrade: "Upgraden",
            sell: "Verkopen",
            close: "Sluiten",
            ads: [
                "Singles in jouw buurt willen tower defense spelen!",
                "Artsen HATEN deze truc om vijanden te verslaan!",
                "Je gelooft niet hoe Golf 50 eruitziet!",
                "Download RAM om je torens sneller te laten schieten!",
                "Dit spel is verboden in 0 landen!",
                "Gefeliciteerd! Je bent onze 1.000.000e verdediger!",
                "Wetenschappers ontdekten dit nieuwe torentype!",
                "Word rijk met deze SIMPELE torenplaatsing!",
                "Je torens hebben een update nodig! Klik hier! (Grapje)",
                "Waarschuwing: Je verdediging is niet geoptimaliseerd! (Eigenlijk prima)"
            ]
        }
    },

    // Detect user language
    detectLanguage() {
        // First check if user has saved a preference
        const savedLang = localStorage.getItem('preferredLanguage');
        if (savedLang && this.translations[savedLang]) {
            return savedLang;
        }

        // Otherwise use browser language
        const browserLang = navigator.language || navigator.userLanguage;
        const langCode = browserLang.split('-')[0]; // Get language without region

        // Check if we support this language
        if (this.translations[langCode]) {
            return langCode;
        }

        // Default to English
        return 'en';
    },

    // Current language
    currentLang: null,

    // Initialize
    init() {
        this.currentLang = this.detectLanguage();
        this.updateUI();
        this.initLanguageSelector();
    },

    // Initialize language selector
    initLanguageSelector() {
        const selector = document.getElementById('language-selector');
        if (selector) {
            // Set current language
            selector.value = this.currentLang;

            // Add change event listener
            selector.addEventListener('change', (e) => {
                this.changeLanguage(e.target.value);
            });
        }
    },

    // Change language
    changeLanguage(langCode) {
        if (this.translations[langCode]) {
            this.currentLang = langCode;
            localStorage.setItem('preferredLanguage', langCode);
            this.updateUI();

            // Update game elements that might have cached text
            this.updateGameElements();

            // Trigger ad refresh if ad manager exists
            if (window.fakeAdManager && window.fakeAdManager.showRandomAd) {
                window.fakeAdManager.showRandomAd();
            }
        }
    },

    // Get translation
    t(key) {
        return this.translations[this.currentLang][key] || this.translations['en'][key] || key;
    },

    // Get random ad
    getRandomAd() {
        const ads = this.translations[this.currentLang].ads || this.translations['en'].ads;
        return ads[Math.floor(Math.random() * ads.length)];
    },

    // Update all UI elements with translations
    updateUI() {
        // Update static text elements
        const elements = {
            // Labels
            '#wave-label': 'wave',
            '#coins-label': 'coins',
            '#start-wave-btn': 'startWave',
            '#new-game-btn': 'newGame',
            '.toggle-text': 'auto',
            '.speed-controls .label': 'speed',

            // Tower names
            '[data-tower-type="basic"] .tower-name': 'basic',
            '[data-tower-type="sniper"] .tower-name': 'sniper',
            '[data-tower-type="splash"] .tower-name': 'splash',
            '[data-tower-type="freeze"] .tower-name': 'ice',
            '[data-tower-type="poison"] .tower-name': 'poison',
            '[data-tower-type="chain"] .tower-name': 'chain',
            '[data-tower-type="laser"] .tower-name': 'laser',

            // Game over screen
            '#game-over-screen h2': 'gameOver',
            '#restart-btn': 'playAgain',

            // Upgrade panel
            '#upgrade-panel h4': 'towerUpgrade',
            '#close-upgrade-btn': 'close'
        };

        // Update each element
        Object.entries(elements).forEach(([selector, key]) => {
            const elem = document.querySelector(selector);
            if (elem) {
                // Add colon for label elements
                if (selector.includes('label') || selector.includes('-label')) {
                    elem.textContent = this.t(key) + ':';
                } else {
                    elem.textContent = this.t(key);
                }
            }
        });

        // Update complex elements
        this.updateComplexElements();

        // Update speed label
        const speedLabel = document.querySelector('.speed-controls .label');
        if (speedLabel) {
            speedLabel.textContent = this.t('speed') + ':';
        }
    },

    updateGameElements() {
        // Update all dynamic game elements
        if (window.gameEngine && window.gameEngine.uiManager) {
            window.gameEngine.uiManager.updateDisplay();

            // Update upgrade panel if it's open
            if (window.gameEngine.uiManager.selectedTower) {
                window.gameEngine.uiManager.showUpgradePanel(
                    window.gameEngine.uiManager.selectedTower
                );
            }
        }

        // Force map redraw to update spawn text
        if (window.gameEngine && window.gameEngine.map) {
            window.gameEngine.render();
        }
    },

    updateComplexElements() {
        // Update HP text
        const hpText = document.getElementById('hp-text');
        if (hpText) {
            const hpMatch = hpText.innerHTML.match(/(\d+)\/(\d+)/);
            if (hpMatch) {
                hpText.innerHTML = `${this.t('hp')}: ${hpMatch[1]}/${hpMatch[2]}`;
            }
        }

        // Update upgrade button
        const upgradeBtn = document.getElementById('upgrade-btn');
        if (upgradeBtn) {
            const costSpan = upgradeBtn.querySelector('#upgrade-cost');
            if (costSpan) {
                const cost = costSpan.textContent;
                upgradeBtn.innerHTML = `${this.t('upgrade')} (💰 <span id="upgrade-cost">${cost}</span>)`;
            }
        }

        // Update sell button
        const sellBtn = document.getElementById('sell-btn');
        if (sellBtn) {
            const valueSpan = sellBtn.querySelector('#sell-value');
            if (valueSpan) {
                const value = valueSpan.textContent;
                sellBtn.innerHTML = `${this.t('sell')} (💰 <span id="sell-value">${value}</span>)`;
            }
        }

        // Update game over message
        const finalWaveElem = document.getElementById('final-wave');
        const highScoreElem = document.getElementById('high-score');
        if (finalWaveElem && finalWaveElem.parentElement) {
            const waveNum = finalWaveElem.textContent;
            finalWaveElem.parentElement.innerHTML = `${this.t('youReachedWave')} <span id="final-wave">${waveNum}</span>`;
        }
        if (highScoreElem && highScoreElem.parentElement) {
            const scoreNum = highScoreElem.textContent;
            highScoreElem.parentElement.innerHTML = `${this.t('highScore')} <span id="high-score">${scoreNum}</span>`;
        }
    }
};